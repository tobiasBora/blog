<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Building a reproducible blog with Nix</title>
  <link rel="stylesheet" href="../../../assets/css/main.css" />
  <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="../../../rss.xml" />
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="../../../atom.xml" />
</head>

<body>
  <header id="header" class="uk-navbar-container">
  <div class="uk-container uk-flex uk-flex-column uk-flex-middle">

    <div class="uk-flex uk-flex-middle uk-width-1-1 uk-flex-wrap uk-margin-large-top uk-margin-medium-bottom">
      <div class="uk-container uk-flex uk-flex-right uk-flex-middle uk-width-expand@s uk-width-1-1">
        <span class="uk-text-right">
          <h1 class="uk-article-title">Building a reproducible blog with Nix</h1>
          <p>How I use Nix to manage the development and CI of this blog</p>
        </span>
      </div>
      <div class="uk-visible@s uk-width-auto">
        <hr class="uk-divider-vertical uk-margin-left uk-margin-right">
      </div>
      <div class="uk-container uk-flex uk-flex-column uk-flex-center uk-width-2-5@s uk-width-1-1 uk-text-muted uk-text-small">
        <ul class="uk-list">
          <li class="uk-flex">
            <span class="uk-margin-small-right uk-flex-none" uk-icon="calendar"></span>
            April 10, 2020
          </li>
          <li class="uk-flex">
            <span class="uk-margin-small-right uk-flex-none" uk-icon="clock"></span>
            13 Minutes
          </li>
          
          <li class="uk-flex-inline" style="overflow-wrap: break-word;">
            <span class="uk-margin-small-right uk-flex-none " uk-icon="bookmark"></span>
            
            <span>
              <a class="uk-text-emphasis uk-link-text" href="../../../tags/internal.html">internal</a>,
              
            <span>
              <a class="uk-text-emphasis uk-link-text" href="../../../tags/technical.html">technical</a>,
              
            <span>
              <a class="uk-text-emphasis uk-link-text" href="../../../tags/nix.html">nix</a>,
              
            <span>
              <a class="uk-text-emphasis uk-link-text" href="../../../tags/haskell.html">haskell</a>
              </span>
          </li>
          
          <li class="uk-flex">
            <span class="uk-margin-small-right uk-flex-none" uk-icon="git-branch"></span>
            <a class="uk-link-muted" href="https://github.com/ysndr/blog/commit/2d8ecbe">2d8ecbe: Fix a few typos in built-with-nix.</a>
          </li>

        </ul>
      </div>
    </div>
    <hr class="uk-width-1-1" />
  </div>

</header>


  <header class="uk-navbar-container uk-position-z-index uk-width-1-1" style="
    position: sticky;
    align-self: flex-start;
    top: 0;
">
  <nav class="uk-container" uk-navbar>

    <div class="uk-navbar-center ">
      <div class="uk-navbar-nav uk-flex-1">

        <li class="uk-logo"><a href="../../../">
            <img src="../../../assets/images/logo-small.svg" alt="y|sndr" class="logo" />
          </a>
        </li>

      </div>
    </div>

    <div class="uk-navbar-left">
      <ul class="uk-navbar-nav">
        <li>
          <a><span uk-navbar-toggle-icon></span> <span class="uk-margin-small-left">Menu</span></a>
          <div class="uk-navbar-dropdown" uk-drop="boundary: nav; boundary-align: true; pos: bottom-justify; offset: 0">

            <div class="uk-navbar-dropdown-grid uk-child-width-1-3@s uk-child-width-1-1" uk-grid>
              <div>
                <ul class="uk-nav uk-navbar-dropdown-nav">
                  <li class="uk-nav-header">Who?</li>
                  <li><a href="../../../about.html">About Me</a></li>
                  <li><a href="https://gist.github.com/ysndr/978662957bb9187fd52b2037466e1e34">CV</a></li>
                  <li class="uk-nav-divider uk-margin-bottom"></li>
                  <li class>
                    <ul class="uk-iconnav uk-iconnav-horizontal">
                      <li><a href="mailto:contact@ysndr.de" uk-icon="mail"></a></li>
                      <li><a href="https://linkedin.com/in/yannik-sander" uk-icon="linkedin"></a>
                      </li>
                      <li><a href="https://github.com/ysndr" uk-icon="github"></a></li>
                    </ul>
                  </li>
                </ul>
              </div>
              <div>
                <ul class="uk-nav uk-navbar-dropdown-nav">
                  <li class="uk-nav-header">What?</li>
                  <li><a href="https://github.com/ysndr">Projects</a></li>
                  <li class="uk-nav-divider"></li>
                  <li><a href="https://github.com/ysndr/sam-knn-regressor">sam-knn-regressor</a></li>
                  <li><a href="https://github.com/ysndr/nixos-config">NixOS Config</a></li>
                </ul>
              </div>
              <div>
                <ul class="uk-nav uk-navbar-dropdown-nav">
                  <li class="uk-nav-header">Posts</li>
                  <li><a href="../../../archive.html">Archive</a></li>
                  <li class="uk-flex">
                    <span uk-icon="rss" class="uk-text-muted"></span>
                    <ul class="uk-iconnav uk-subnav-divider">
                      <li><a href="../../../rss.xml">RSS</a></li>
                      <li><a href="../../../atom.xml">Atom</a></li>
                    </ul>
                  </li>
                  <li class="uk-nav-divider"></li>
                  <li><a href="https://github.com/ysndr/blog/commit/2d8ecbe"><span uk-icon="git-branch"></span>current rev.: 2d8ecbe: Fix a few typos in built-with-nix.</a></li>
                </ul>
              </div>
            </div>


          </div>
      </ul>
    </div>
    
    <div class="uk-navbar-right">
      <ul class="uk-navbar-nav">
        <li>
        <a><div class="uk-button uk-text-muted uk-button-default" type="button"><span class="uk-hidden@m">Content</span> <span class="uk-visible@m">Table of Contents</span></div></a>
        <div class="uk-navbar-dropdown y-toc" uk-drop="pos: bottom-right; offset: 0">
           <div class="uk-list" uk-scrollspy-nav="closest: li; scroll: true; offset: 85"><ul class="uk-nav-default uk-list uk-nav-sub"><li><a href="#building-a-reproducible-blog-with-nix">Building a reproducible blog with Nix</a><ul class="uk-nav-default uk-list uk-nav-sub"><li><a href="#what-is-nix">What is Nix?</a><ul class="uk-nav-default uk-list uk-nav-sub"><li><a href="#notice">Notice</a></li><li><a href="#how-to-installuse-packages">How to install/use packages?</a><ul class="uk-nav-default uk-list uk-nav-sub"><li><a href="#global-installation">Global installation</a></li><li><a href="#local-usage">Local usage</a></li></ul></li></ul></li><li><a href="#nix-on-this-blog">Nix on this blog</a><ul class="uk-nav-default uk-list uk-nav-sub"><li><a href="#default.nix"><code>default.nix</code></a></li><li><a href="#shell.nix-and-nixpkgs.nix"><code>shell.nix</code> and <code>nixpkgs.nix</code></a></li></ul></li><li><a href="#nix-and-github-actions">Nix and GitHub Actions</a></li><li><a href="#epilog">Epilog</a></li></ul></li></ul></div>
        </div>

      </li>


      </ul>
    </div>
    

  </nav>

</header>


  <main>
    <div class="uk-container">
      <section class="uk-section uk-padding-remove-op">
    
    
    <div class="uk-background-center-center uk-background-cover uk-height-medium uk-height-large@s uk-height-xlarge@m uk-flex uk-box-shadow-xlarge uk-margin-bottom" style="background-image: url(https://images.unsplash.com/photo-1565058290014-df9bd491a29c); border-radius: 4px; ">
    <!-- <div class="uk-overlay uk-overlay-default uk-position-bottom">
        <p class="uk-text-lead uk-container"><i>Nix is a purely functional package manger that allows isolated development environments and builds. This blog uses it to provide a development environment and to build the blog in a GitHub Action</i></p>
    </div> -->
    <div class="uk-container uk-flex uk-width-1-1 uk-flex-right uk-flex-bottom">
        <div class="uk-inline uk-padding-small">
            <div class="uk-button uk-background-muted uk-border-circle uk-drop-shadow-xlarge" style="line-height: 0; padding:4px;" type="button"><span uk-icon="info"></span></div>
            <div uk-drop="pos: top-right">
                <div class="uk-card uk-card-default uk-card-body uk-card-hover">
                    <h4 class="uk-card-title">Credits</h4>
                    
                    Photo by <a style="background-color:black;color:white;text-decoration:none;padding:4px 6px;font-family:-apple-system, BlinkMacSystemFont, &quot;San Francisco&quot;, &quot;Helvetica Neue&quot;, Helvetica, Ubuntu, Roboto, Noto, &quot;Segoe UI&quot;, Arial, sans-serif;font-size:12px;font-weight:bold;line-height:1.2;display:inline-block;border-radius:3px" href="https://unsplash.com/@the_roaming_platypus?utm_medium=referral&amp;utm_campaign=photographer-credit&amp;utm_content=creditBadge" target="_blank" rel="noopener noreferrer" title="Download free do whatever you want high-resolution photos from timJ"><span style="display:inline-block;padding:2px 3px"><svg xmlns="http://www.w3.org/2000/svg" style="height:12px;width:auto;position:relative;vertical-align:middle;top:-2px;fill:white" viewBox="0 0 32 32"><title>unsplash-logo</title><path d="M10 9V0h12v9H10zm12 5h10v18H0V14h10v9h12v-9z"></path></svg></span><span style="display:inline-block;padding:2px 3px">timJ</span></a> on Unsplash
                    
                </div>
            </div>
        </div>
    </div>

</div>



    <article class="uk-article">

    <p class="uk-text-lead"><i>Nix is a purely functional package manger that allows isolated development environments and builds. This blog uses it to provide a development environment and to build the blog in a GitHub Action</i></p>
    <p><h1 id="building-a-reproducible-blog-with-nix">Building a reproducible blog with Nix</h1>
<p>This blog is hosted by <a href="https://pages.github.com/">GitHub Pages</a>. GitHub Pages, aside static HTML content, only supports building Jekyll pages natively. At some point a website like this one has to be <strong>generated</strong>, i.e. turned into static HTML content. This means Markdown has to be converted to HTML static pages (like the <a href="../../../">homepage</a>), an <a href="../../../archive.html">archive</a> has to be created, and <a href="../../../rss.xml">RSS</a> and <a href="../../../atom.xml">ATOM</a> feeds have to be produced. In this blog’s case, this is done by a Haskell DSL called <a href="https://jaspervdj.be/hakyll/">Hakyll</a>. More details about that can be found in <a href="2019-12-31-built-with-hakyll-part-1.html">prior articles</a>.</p>
<p>In order to keep everything in the same place, I use <a href="https://github.com/features/actions">GitHub Actions</a> as a mean to automatically build and publish this blog whenever I push updates or merge pull requests.</p>
<p><strong>Was this not an article about Nix?</strong></p>
<p>Yes indeed it is. In order to create reproducible builds of this blog I employ the <a href="https://nixos.org/nix">Nix</a> package manager. But in order…</p>
<div class="uk-alert info">
<p>Jump to <a href="#nix-on-this-blog">Nix on this blog</a> if you know nix already.</p>
</div>
<h2 id="what-is-nix">What is Nix?</h2>
<p>Nix is sort of a hybrid tool between a package manager and a build system. The Nix homepage states:</p>
<blockquote>
<p>Nix is a powerful package manager for Linux and other Unix systems that makes package management reliable and reproducible. It provides atomic upgrades and rollbacks, side-by-side installation of multiple versions of a package, multi-user package management and easy setup of build environments.</p>
</blockquote>
<p>Sounds… good? What does all of that mean though?</p>
<p>Nix (the package manager) is built around the functional programming language <code>nix</code> (what a coincidence, ha?). A program, library, etc. is built by Nix as the output of a pure function. Runtime/buildtime dependencies go in mix with the sources of the package, are built in an isolated space, and output an executable or whatever you want to build. Such a function is called a <strong>Derivation</strong>.</p>
<p>Everything that should be built with Nix has to be described as such a function. In fact, the whole set of packages that is there is just <a href="https://github.com/nixos/nixpkgs">a giant collection</a> of functions, each defined in their own files.</p>
<p>The isolated manner in which the packages are built also shows in the way they are managed. All packages are installed as such:</p>
<pre><code>/nix/store/6fgjp1wsv1w44f890f6kvwywjnc32svr-zoxide-0.2.1/bin/zoxide</code></pre>
<p>Lets take this apart:</p>
<dl>
<dt><code>/nix/store/</code></dt>
<dd>This is the nix store all packages are contained in this folder
</dd>
<dt><code>6fgjp1wsv1w44f890f6kvwywjnc32svr</code></dt>
<dd>This is a hash of the producing function, it takes into account the function itself, and its inputs
</dd>
<dd>It also easens binary caching.
</dd>
<dt><code>zoxide</code></dt>
<dd>the package’s name
</dd>
<dt><code>0.2.1</code></dt>
<dd>the packaged version
</dd>
<dt><code>/bin/zoxide</code></dt>
<dd>the actual executable
</dd>
<dd>actually the file structure of packages is similar to what you would normally find in places like <code>/usr</code> or <code>~/.local/</code>
</dd>
</dl>
<p>Yet, while that package might exists in the store, this does not mean it is <em>installed</em> or usable. — Huh?</p>
<p>You see, the hash we have seen right now is there for a reason. It allows to have multiple versions of one and the same program at the same time, even with the same version. Normally all packages are built according to one specific state of the <code>nixpkgs</code> repo. <code>.nix</code> files get evaluated by writing a build instruction file (<code>.drv</code>). This resolves all dependencies (building them if they do not exist yet), prepares the package’s source and combines those into a hash. If one instead builds it with a newer version where some dependency was updated or changed, not only this derivation hash changes, but it also happens to change the target derivation’s hash, forcing it to be rebuilt using the new dependency. The same happens if sources change. As a result, many different versions of a package can coexist in the store.</p>
<section id="notice" class="uk-alert-primary uk-alert note">
<h3>Notice</h3>
<p>As nix functions are pure, <strong>wherever</strong> one uses the same <code>nixpkgs</code> instance, the exact same inputs are used to create the exact same output. Also, it makes little to no difference on which machine the package is built. The binary will be the same(ish).</p>
<p>Actually, there is a <a href="https://r13y.com/">project</a> tracking how many builds (of a vital subset of nix) are reproducible on two different machines.</p>
</section>
<h3 id="how-to-installuse-packages">How to install/use packages?</h3>
<h4 id="global-installation">Global installation</h4>
<p>There are different ways to achive this. Using nix locally, the easiest but least idiomatic would be:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>$ <span class="ex">nix-env</span> -iA zoxide</span></code></pre></div>
<p>This installs <code>zoxide</code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>) globally for the current user, by linking all of zoxides contents to a special directory (<code>~/.nix-profile/</code>). The <code>bin</code> contents of this directory are on the <code>$PATH</code> making the package’s binary available to the user.</p>
<p>As mentioned this is not idiomatic Nix, which focuses on declerativity. If you want something installed, consider using <a href="https://github.com/rycee/home-manager"><code>home-manager</code></a> or add packages to your <code>configuration.nix</code> if you are on <a href="https://nixos.org/nixos">NixOS</a>.</p>
<h4 id="local-usage">Local usage</h4>
<p>If you need a program but do not want to install it because you don’t need it often and you don’t want to clutter your <code>$PATH</code>, or it’s a project specific tool you can make use of either <code>nix run</code> or <code>nix-shell</code>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>$ <span class="ex">nix</span> run nixpkgs.git</span></code></pre></div>
<p>This will drop you into a Bash shell with git available.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>$ <span class="ex">nix-shell</span> -p git</span></code></pre></div>
<p>This will essentially do the same but can do much more.</p>
<ul>
<li><p><code>nix-shell</code> accepts multiple packages</p></li>
<li><p>can be used as a shebang (<a href="https://gist.github.com/travisbhartwell/f972aab227306edfcfea">see</a>)</p></li>
<li><p>can drop you into development environments of a specific derivation (<a href="https://nixos.org/nixos/nix-pills/developing-with-nix-shell.html">see</a>)</p></li>
<li><p>can be used to make development environments for a project.</p></li>
</ul>
<p>Let’s focus on the last point for this article.</p>
<h2 id="nix-on-this-blog">Nix on this blog</h2>
<p>This blog uses a shell environment in which I have all the tools I need at hand. Let’s look at the structure file by file.</p>
<h3 id="default.nix"><code>default.nix</code></h3>
<p>By default, Nix commands such as <code>nix-build</code> read the <a href="https://github.com/ysndr/blog/default.nix"><code>default.nix</code></a> file in the directory they are executed from. In my projects, I use them to define and export everything that might be useful. This might include build tools, language environments, scripts or shells.</p>
<p>Generally my <code>default.nix</code> file looks like this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>{<span class="ex">pkgs</span> ? import (if pin == false then <span class="op">&lt;</span>nixpkgs<span class="op">&gt;</span> else pin) {},</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a> <span class="ex">pin</span> ? ./nixpkgs.nix, ... }:</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">with</span> pkgs<span class="kw">;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="bu">let</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span><span class="ex">some</span> packages and configuration<span class="op">&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="ex">shell</span> = mkShell {</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>​    <span class="ex">name</span> = <span class="st">&quot;&lt;name&gt;&quot;</span><span class="kw">;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>​    <span class="ex">buildInputs</span> = [ <span class="op">&lt;</span>packages I want in my shell<span class="op">&gt;</span> ]<span class="kw">;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>​    <span class="ex">shellHook</span> = <span class="st">''</span> # shell command to be executed when I enter the shell</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>​    <span class="st">''</span>;</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>​    <span class="ex">inherit</span> shell<span class="kw">;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>​    <span class="ex">inherit</span> packageA, packageB, ...<span class="kw">;</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>This exposes a shell environment for <code>nix-shell</code> and programs to be executed directy using <code>nix-build</code>.</p>
<p>So what about this blog’s <code>default.nix</code>?</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">let</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">all-hies</span> = import (builtins.fetchTarball <span class="st">&quot;https://github.com/infinisil/all-hies/tarball/master&quot;</span>) {};</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>{<span class="ex">pkgs</span> ? import (if pin == false then <span class="op">&lt;</span>nixpkgs<span class="op">&gt;</span> else pin) {},</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">pin</span> ? ./nixpkgs.nix, ... }:</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="ex">with</span> pkgs<span class="kw">;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="bu">let</span></span></code></pre></div>
<p>Aside from the default, I only priorly import <code>all-hies</code>, which is a project that maintains the <a href="https://github.com/infinisil/all-hies">Haskell Ide Engine</a> on Nix.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------- Utils -------------</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">nur</span> = import (builtins.fetchTarball <span class="st">&quot;https://github.com/nix-community/NUR/archive/master.tar.gz&quot;</span>) <span class="kw">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>​    <span class="va">pkgs=</span>pkgs;</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span>;</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="ex">script</span> = <span class="dt">{...}</span> @ args: nur.repos.ysndr.lib.wrap ({</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">shell</span> = true<span class="kw">;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>} <span class="ex">//</span> args);</span></code></pre></div>
<p>This are utilities I might use. <a href="https://github.com/nix-community/NUR">NUR</a> is the nix version of arch’s AUR, albeit not nearly as active sadly. From my own collection, I use the <code>shell</code> script which helps me putting together runnable scripts.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------- Haskell ------------</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">hie</span> = all-hies.selection { selector = p: { inherit (p) <span class="ex">ghc865</span><span class="kw">;</span> }; };</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="ex">myHaskellPackages</span> = haskell.packages.ghc865.extend( self: super: { });</span></code></pre></div>
<p>These lines prepare the Haskell environment I use here. I do not override anything from GHC so this is a bit superflous.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------ dist ---------------</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">thirdparty</span> = linkFarm <span class="st">&quot;thirdparty&quot;</span> [</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">{</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>​    <span class="ex">name</span> = <span class="st">&quot;uikit&quot;</span><span class="kw">;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>​    <span class="ex">path</span> = (fetchTarball <span class="st">&quot;https://github.com/uikit/uikit/archive/v3.2.4.tar.gz&quot;</span>) <span class="ex">+</span> <span class="st">&quot;/src&quot;</span><span class="kw">;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>];</span></code></pre></div>
<p>I import all third party tools (only uikit currently) into the nix store.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------- generator -----------</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="ex">generator</span> = myHaskellPackages.callCabal2nix <span class="st">&quot;Site&quot;</span> ./generator {};</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ex">generator-with-thirdparty</span> = generator.overrideAttrs(old: {</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">nativeBuildInputs</span> = old.nativeBuildInputs or [] ++ [makeWrapper]<span class="kw">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">installPhase</span> = old.installPhase + <span class="st">&quot;\n&quot;</span> + <span class="st">''</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>​    <span class="ex">wrapProgram</span> <span class="va">$out</span>/bin/generator --set THIRDPARTY <span class="va">${thirdparty}</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">''</span>;</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>});</span></code></pre></div>
<p>Then, I define the <code>generator</code> as a derivation from its Cabal file and the corresponding “Site” executable key defined in <code>./generator/</code>. <code>generator-with-thirdparty</code> makes what I imported as thirdparty content available under the <code>$THIRDPARTY</code> environment variable.</p>
<div class="uk-alert-primary uk-alert note">
<p><strong>Notice:</strong> <code>myHaskellPackages.callCabal2nix "Site" ./generator {};</code> is a great tool to quickly make haskell programms available through Nix.</p>
<p>Similar helpers also exist for Stack.</p>
</div>
<div class="sourceCode" id="cb11"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------- Commands ----------------</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ex">generate-website</span> = script {</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">name</span> = <span class="st">&quot;generate-website&quot;</span><span class="kw">;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">paths</span> = [generator-with-thirdparty git]<span class="kw">;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">script</span> = <span class="st">''</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>​    <span class="ex">generator</span> rebuild</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">''</span>;</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>};</span></code></pre></div>
<p><code>generate-website</code> is supposed to be a build command which, at this state, only runs <code>generator rebuild</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------- Shell ------------------</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="ex">haskell-env</span> = myHaskellPackages.ghcWithHoogle (</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">hp</span>: with hp<span class="kw">;</span><span class="bu"> [</span> cabal-install<span class="bu"> ]</span> <span class="ex">++</span> generator.buildInputs );</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="ex">shell</span> = { enable-hie ? false }: <span class="ex">mkShell</span> {</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">name</span> = <span class="st">&quot;blog-env&quot;</span><span class="kw">;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">buildInputs</span> = [</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>​    # <span class="ex">put</span> packages here.</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>​    # <span class="ex">generator</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>​    <span class="ex">haskell-env</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>​    <span class="kw">(</span><span class="ex">lib.optional</span> (enable-hie<span class="kw">)</span> <span class="ex">hie</span>) # <span class="ex">optionally</span> setup hie</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  ];</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="ex">shellHook</span> = <span class="st">''</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>​    <span class="bu">export</span> <span class="va">THIRDPARTY=</span><span class="st">&quot;</span><span class="va">${thirdparty}</span><span class="st">&quot;</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>​    <span class="bu">export</span> <span class="va">HIE_HOOGLE_DATABASE=</span><span class="st">&quot;</span><span class="va">${haskell-</span>env<span class="va">}</span><span class="st">/share/doc/hoogle/default.hoo&quot;</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>​    <span class="bu">export</span> <span class="va">NIX_GHC=</span><span class="st">&quot;</span><span class="va">${haskell-</span>env<span class="va">}</span><span class="st">/bin/ghc&quot;</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>​    <span class="bu">export</span> <span class="va">NIX_GHCPKG=</span><span class="st">&quot;</span><span class="va">${haskell-</span>env<span class="va">}</span><span class="st">/bin/ghc-pkg&quot;</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>​    <span class="bu">export</span> <span class="va">NIX_GHC_DOCDIR=</span><span class="st">&quot;</span><span class="va">${haskell-</span>env<span class="va">}</span><span class="st">/share/doc/ghc/html&quot;</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>​    <span class="bu">export</span> <span class="va">NIX_GHC_LIBDIR=$(</span> <span class="va">$NIX_GHC</span> <span class="ex">--print-libdir</span> <span class="va">)</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">''</span>;</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>};</span></code></pre></div>
<p>Finally, I bundle everything together to build an environment with <code>ghc</code> and a Hoogle index containing the generators dependencies as well as <code>cabal-install</code> <strong>for reasons</strong>.</p>
<p>The shell has this Haskell environment and optionally the <code>hie</code> executable exposed. It also sets some exports that hie needs to properly function as well as the <code>$THIRDPARTY</code> variable to build the blog:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span> <span class="kw">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">inherit</span> shell generator generate-website <span class="kw">;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">ci</span> = {</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>​    <span class="ex">compile</span> = generate-website<span class="kw">;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span>;</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>All important parts are exported.</p>
<h3 id="shell.nix-and-nixpkgs.nix"><code>shell.nix</code> and <code>nixpkgs.nix</code></h3>
<p>The first file is used by nix-shell by default. All it does is call the shell attribute of the <code>default.nix</code> and controlling if hie is added, making use of the lazy nature of nix: hie will not get evaluated unless enabled.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span> <span class="ex">pin</span> ? null, enable-hie ? false <span class="kw">}</span> <span class="ex">@</span> args:</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">import</span> ./default.nix args<span class="kw">)</span><span class="ex">.shell</span> { inherit enable-hie<span class="kw">;</span> }</span></code></pre></div>
<p>The <code>nixpkgs.nix</code> file defines a common snapshot of the nixpkgs repo, and is therefore important to ensure everything works on other machines.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>{}: <span class="ex">import</span> (builtins.fetchTarball {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">url</span> = <span class="st">&quot;https://github.com/NixOS/nixpkgs/archive/88d9f776091.tar.gz&quot;</span><span class="kw">;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">sha256</span> = <span class="st">&quot;sha256:0z8a0g69fmbbzi77jhvhwafv73dn5fg3gsr0q828lss6j5qpx995&quot;</span><span class="kw">;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>}) {}</span></code></pre></div>
<div class="uk-alert-primary uk-alert note">
<p><strong>Notice:</strong> snapshots like these also allow rollbacks as they define which versions of dependencies get passed on.</p>
</div>
<h2 id="nix-and-github-actions">Nix and GitHub Actions</h2>
<p>Nix has some integration with GitHub Actions through <a href="https://github.com/marketplace/actions/install-nix">install-nix</a>, an action that <strong>installs nix</strong> •_•</p>
<p>With nix installed, I run <code>$(nix-build -A ci.compile --no-out-link)</code> to make Nix build the blog generator and rebuild the blog’s content into <code>build/site</code>. This works because <code>nix-build --no-out-link</code> will just print the path of the resulting package to <code>stdout</code>, which in this case is only an executable script produced by the <code>script</code> function above. The next step is to take that content and push it to the deployment branch.</p>
<p><a href="https://github.com/ysndr/blog/blob/release/.github/workflows/main.yml">See more…</a></p>
<div class="uk-alert-primary uk-alert note">
<p>I previously did even more with nix but specific GitHub Actions tend to do the job well enough.</p>
</div>
<h2 id="epilog">Epilog</h2>
<p>I see this has become more of a roundup about Nix. Nix is <strong>huge</strong> though.. and this article does not try to capture everything (obviously). From reading this, I hope you have a rough idea of what nix does and how it was applied here. If you knew Nix already, maybe you found something new or interesting among this pile of words and snippets. If you did not know Nix before, I hope this article was still of interest to you.</p>
<div class="uk-alert info">
<p>If you are hooked on the idea now, further fine grained introduction and resources are:</p>
<ul>
<li>The <a href="https://nixos.org/nixos/nix-pills/">Nix-Pills</a></li>
<li>The <strong>unofficial</strong> <a href="https://nixos.wiki/wiki/Nix">wiki</a></li>
<li>The nixpkgs <a href="https://github.com/nixos/nixpkgs">repo</a>. Trust me, if you plan to try out nix, bookmark this project and use the issue search.</li>
</ul>
</div>
<p><strong>Thank you for getting here!</strong> I hope you enjoyed it and have learned something. If you have questions, improvements, or any other comment, do not hesitate to get in touch on <a href="https://github.com/ysndr/blog/issues/new">GitHub</a>.</p>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p><a href="https://github.com/ajeetdsouza/zoxide"><code>zoxide</code></a> (a great (fast) replacement for <code>z</code><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></p>

</article>

</section>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
<!--[if lt IE 9]>
  <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
<![endif]-->

    </div>
  </main>


  <footer class="uk-section uk-section-secondary ">
    <div class="uk-container">
      <div class="uk-grid-medium uk-child-width-1-3@m uk-child-width-1-1" uk-grid>
        <div>
          <div class>
            <h3 class>Contact</h3>
            <p><span uk-icon="mail"></span> <a href="mailto:contact@ysndr.de">contact@ysndr.de</a></p>
            <p><span uk-icon="github"></span> <a href="https://github.com/ysndr">ysndr</a></p>
            <p><span uk-icon="linkedin"></span> <a href="https://linkedin.com/in/yannik-sander">yannik-sander</a></p>
          </div>
        </div>
        <div>
          <div class>
            <h3 class>Legal</h3>
            <p><span uk-icon="check"></span> <span href="mailto:contact@ysndr.de">No analytics are used here your data is
                safe :)</span></p>
            <p><span uk-icon="check"></span> <span href="https://github.com/ysndr">The content of this blog is licensed under
                CC0 terms if not otherwise noted</span></p>
          </div>
        </div>
        <div>
          <div class>
            <h3 class>About this blog</h3>
            <p>Built with <span uk-icon="code"></span> and <span uk-icon="heart"></span> using <a href="https://jaspervdj.be/hakyll/">Hakyll</a></p>
            <p><a href="https://builtwithnix.org" rel="nofollow"><img src="https://builtwithnix.org/badge.svg" " style="max-width:100%;"></a></p>
            <p class="uk-text-muted"><span uk-icon="git-branch"></span> last updated: <a href="https://github.com/ysndr/blog">2d8ecbe: Fix a few typos in built-with-nix. (2020-07-04 14:31:17 +0200)</a>
            </p>
          </div>
        </div>
      </div>
    </div>

    </div>
    </div>
  </footer>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.2.0/js/uikit.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.2.0/js/uikit-icons.min.js"></script>
</body>

</html>
